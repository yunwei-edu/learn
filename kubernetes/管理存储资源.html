<html>
<head>
  <title>Evernote Export</title>
  <basefont face="微软雅黑" size="2" />
  <meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
  <meta name="exporter-version" content="YXBJ Windows/600240 (zh-CN, DDL); Windows/10.0.0 (Win64);"/>
  <style>
    body, td {
      font-family: 微软雅黑;
      font-size: 10pt;
    }
  </style>
</head>
<body>
<a name="977"/>

<div>
<span><div style="-evernote-webclip:true;"><div style="text-align: center;"><br/></div><div style="text-align: center;"><font style="font-size: 14pt;"><span style="display: inline-block; box-sizing: border-box; letter-spacing: 0.442px; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(0, 88, 156); font-size: 14pt; color: rgb(255, 255, 255); font-family: -apple-system-font, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif; font-variant-caps: normal; font-variant-ligatures: normal;-evernote-webclip:true;">第7篇</span><span style="display: inline-block;box-sizing: border-box;orphans: 2;text-indent: 0px;text-transform: none;white-space: normal;widows: 2;word-spacing: 0px;-webkit-text-stroke-width: 0px;letter-spacing: 0.034em;-evernote-webclip:true;"><span style="font-size: 14pt; color: rgb(0, 0, 0); font-family: 微软雅黑; font-variant-caps: normal; font-variant-ligatures: normal;">管理存储资源</span></span></font></div><div><br/></div><div><span style="display: inline-block; box-sizing: border-box; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; letter-spacing: 0.034em; font-size: 14pt; clear: both; max-width: 100%; min-height: 1em; overflow-wrap: break-word; text-rendering: optimizeLegibility; color: rgb(54, 101, 238); font-family: -apple-system-font, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif; font-variant-caps: normal; font-variant-ligatures: normal; font-weight: bold; line-height: 28.8px;-evernote-webclip:true;">一、<span style="font-size: 14pt; color: rgb(54, 101, 238); font-family: -apple-system-font; font-variant-caps: normal; font-variant-ligatures: normal; font-weight: bold; line-height: 28.8px;">Kubernetes 如何管理存储资源</span></span><span style="display: inline-block; box-sizing: border-box; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; letter-spacing: 0.034em; font-size: 14pt; clear: both; max-width: 100%; min-height: 1em; overflow-wrap: break-word; text-rendering: optimizeLegibility; color: rgb(54, 101, 238); font-family: -apple-system-font, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif; font-variant-caps: normal; font-variant-ligatures: normal; font-weight: bold; line-height: 28.8px;-evernote-webclip:true;">：</span></div><div style="text-align: left; margin: 5px 0px 0px; padding: 10px; max-width: 100%; box-sizing: border-box; overflow-wrap: break-word; border-style: none none none solid; border-color: rgb(0, 88, 156); box-shadow: rgb(153, 153, 153) 1px 1px 2px; border-left-width: 10px; background-color: rgb(243, 243, 243);"><font style="font-size: 14pt;"><span style="font-size: 14pt; color: rgb(121, 121, 121); font-weight: bold;">理解volume</span></font></div><div style="letter-spacing: 0.034em; background-color: rgb(255, 255, 255);"><div style="overflow-wrap:break-word;hyphens:auto;"><div style="background-color:rgb(255, 255, 255);"><div style="overflow: hidden; overflow-wrap: break-word; text-align: justify;"><div style="font-size: 19.2px; margin: 0px 0px 1.5rem; padding: 0px; max-width: 100%; box-sizing: inherit; clear: both; min-height: 1em; overflow-wrap: break-word; text-rendering: optimizeLegibility;"><span style="font-size: 16px; display: inline-block;"><span style="margin: 0px; padding: 0px; max-width: 100%; box-sizing: border-box; overflow-wrap: break-word; font-size: 16px; color: rgb(51, 51, 51); font-family: -apple-system-font, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif; line-height: 28.8px;">首先我们学习 Volume，以及 Kubernetes 如何通过 Volume 为集群中的容器提供存储；然后我们会实践几种常用的 Volume 类型并理解它们各自的应用场景；最后，我们会讨论 Kubernetes 如何通过 Persistent Volume 和 Persistent Volume Claim 分离集群管理员与集群用户的职责，并实践 Volume 的静态供给和动态供给。</span></span></div><h2 style="font-size: 16px; margin: 2.5rem 0px 0.3rem; padding: 0px; max-width: 100%; box-sizing: inherit; overflow-wrap: break-word;"><strong style="margin:0px;padding:0px;max-width:100%;box-sizing:border-box;overflow-wrap:break-word;"><span style="margin: 0px; padding: 0px; max-width: 100%; box-sizing: border-box; overflow-wrap: break-word; font-size: 20px; font-weight: bold; color: rgb(51, 51, 51); font-family: -apple-system-font, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif; line-height: 1.6;">Volume</span></strong></h2><div style="font-size: 19.2px; margin: 0px 0px 1.5rem; padding: 0px; max-width: 100%; box-sizing: inherit; clear: both; min-height: 1em; overflow-wrap: break-word; text-rendering: optimizeLegibility;"><span style="margin: 0px; padding: 0px; max-width: 100%; box-sizing: border-box; overflow-wrap: break-word; font-size: 16px; color: rgb(51, 51, 51); font-family: -apple-system-font, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif; line-height: 28.8px;">本节我们讨论 Kubernetes 的存储模型 Volume，学习如何将各种持久化存储映射到容器。</span></div><div style="font-size: 19.2px; margin: 0px 0px 1.5rem; padding: 0px; max-width: 100%; box-sizing: inherit; clear: both; min-height: 1em; overflow-wrap: break-word; text-rendering: optimizeLegibility;"><div><span style="margin: 0px; padding: 0px; max-width: 100%; box-sizing: border-box; overflow-wrap: break-word; font-size: 16px; color: rgb(51, 51, 51); font-family: -apple-system-font, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif; line-height: 28.8px;">我们经常会说：容器和 Pod 是短暂的。</span></div><div><span style="margin: 0px; padding: 0px; max-width: 100%; box-sizing: border-box; overflow-wrap: break-word; font-size: 16px; color: rgb(51, 51, 51); font-family: -apple-system-font, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif; line-height: 28.8px;">其含义是它们的生命周期可能很短，会被频繁地销毁和创建。容器销毁时，保存在容器内部文件系统中的数据都会被清除。</span></div></div><div style="font-size: 19.2px; margin: 0px 0px 1.5rem; padding: 0px; max-width: 100%; box-sizing: inherit; clear: both; min-height: 1em; overflow-wrap: break-word; text-rendering: optimizeLegibility;"><span style="margin: 0px; padding: 0px; max-width: 100%; box-sizing: border-box; overflow-wrap: break-word; font-size: 16px; color: rgb(51, 51, 51); font-family: -apple-system-font, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif; line-height: 28.8px;">为了持久化保存容器的数据，可以使用 Kubernetes Volume。</span></div><div style="font-size: 19.2px; margin: 0px 0px 1.5rem; padding: 0px; max-width: 100%; box-sizing: inherit; clear: both; min-height: 1em; overflow-wrap: break-word; text-rendering: optimizeLegibility;"><span style="margin: 0px; padding: 0px; max-width: 100%; box-sizing: border-box; overflow-wrap: break-word; font-size: 16px; color: rgb(51, 51, 51); font-family: -apple-system-font, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif; line-height: 28.8px;">Volume 的生命周期独立于容器，Pod 中的容器可能被销毁和重建，但 Volume 会被保留。</span></div><div style="font-size: 19.2px; margin: 0px 0px 1.5rem; padding: 0px; max-width: 100%; box-sizing: inherit; clear: both; min-height: 1em; overflow-wrap: break-word; text-rendering: optimizeLegibility;"><span style="margin: 0px; padding: 0px; max-width: 100%; box-sizing: border-box; overflow-wrap: break-word; font-size: 16px; color: rgb(51, 51, 51); font-family: -apple-system-font, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif; line-height: 28.8px;">本质上，Kubernetes Volume 是一个目录，这一点与 Docker Volume 类似。当 Volume 被 mount 到 Pod，Pod 中的所有容器都可以访问这个 Volume。Kubernetes Volume 也支持多种 backend 类型，包括 emptyDir、hostPath、GCE Persistent Disk、AWS Elastic Block Store、NFS、Ceph 等，完整列表可参考 </span></div><div style="font-size: 19.2px; margin: 0px 0px 1.5rem; padding: 0px; max-width: 100%; box-sizing: inherit; clear: both; min-height: 1em; overflow-wrap: break-word; text-rendering: optimizeLegibility;"><span style="font-size: 19.2px; letter-spacing: 0.034em; color: rgb(51, 51, 51); font-family: -apple-system-font, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif;">https://kubernetes.io/docs/concepts/storage/volumes/#types-of-volumes</span></div><div style="font-size: 19.2px; margin: 0px 0px 1.5rem; padding: 0px; max-width: 100%; box-sizing: inherit; clear: both; min-height: 1em; overflow-wrap: break-word; text-rendering: optimizeLegibility;"><span style="margin: 0px; padding: 0px; max-width: 100%; box-sizing: border-box; overflow-wrap: break-word; font-size: 16px; color: rgb(51, 51, 51); font-family: -apple-system-font, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif; line-height: 28.8px;">Volume 提供了对各种 backend 的抽象，容器在使用 Volume 读写数据的时候不需要关心数据到底是存放在本地节点的文件系统中呢还是云硬盘上。对它来说，所有类型的 Volume 都只是一个目录。</span></div><div style="font-size: 19.2px; margin: 0px 0px 1.5rem; padding: 0px; max-width: 100%; box-sizing: inherit; clear: both; min-height: 1em; overflow-wrap: break-word; text-rendering: optimizeLegibility;"><span style="display: inline-block; box-sizing: border-box; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; letter-spacing: 0.034em; font-size: 14pt; clear: both; max-width: 100%; min-height: 1em; overflow-wrap: break-word; text-rendering: optimizeLegibility; color: rgb(54, 101, 238); font-family: -apple-system-font; font-variant-caps: normal; font-variant-ligatures: normal; font-weight: bold; line-height: 28.8px;-evernote-webclip:true;">二、<span style="font-size: 14pt; color: rgb(54, 101, 238); font-family: -apple-system-font; font-variant-caps: normal; font-variant-ligatures: normal; font-weight: bold; line-height: 28.8px;">kubernetes</span><span style="font-size: 14pt; color: rgb(54, 101, 238); font-family: -apple-system-font; font-variant-caps: normal; font-variant-ligatures: normal; font-weight: bold; line-height: 28.8px;"> Volume种类</span></span><span style="display: inline-block; box-sizing: border-box; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; letter-spacing: 0.034em; font-size: 14pt; clear: both; max-width: 100%; min-height: 1em; overflow-wrap: break-word; text-rendering: optimizeLegibility; color: rgb(54, 101, 238); font-family: -apple-system-font, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif; font-variant-caps: normal; font-variant-ligatures: normal; font-weight: bold; line-height: 28.8px;-evernote-webclip:true;">：</span></div><div style="text-align: left; margin: 5px 0px 0px; padding: 10px; max-width: 100%; box-sizing: border-box; overflow-wrap: break-word; border-style: none none none solid; border-color: rgb(0, 88, 156); box-shadow: rgb(153, 153, 153) 1px 1px 2px; border-left-width: 10px; background-color: rgb(243, 243, 243);"><span style="font-size: 14pt; color: rgb(121, 121, 121); font-weight: bold;">emptyDir</span></div><div style="margin: 0px 0px 1.5rem; padding: 0px; max-width: 100%; box-sizing: inherit; clear: both; min-height: 1em; overflow-wrap: break-word; text-rendering: optimizeLegibility;"><div style="overflow-wrap: break-word;"><div style="background-color: rgb(255, 255, 255);"><div style="overflow: hidden; overflow-wrap: break-word; text-align: justify;"><div style="font-size: 19.2px; margin: 0px 0px 1.5rem; padding: 0px; max-width: 100%; clear: both; min-height: 1em; overflow-wrap: break-word; text-rendering: optimizeLegibility;"><span style="font-size: 12pt; color: rgb(51, 51, 51); font-family: -apple-system-font;">emptyDir 是最基础的 Volume 类型。正如其名字所示，一个 emptyDir Volume 是 Host 上的一个空目录。</span></div><div style="font-size: 17px;"><span style="font-size: 12pt; color: rgb(51, 51, 51); font-family: -apple-system-font;">emptyDir Volume 对于容器来说是持久的，对于 Pod 则不是。当 Pod 从节点删除时，Volume 的内容也会被删除。但如果只是容器被销毁而 Pod 还在，则 Volume 不受影响。</span></div><div style="font-size: 19.2px; margin: 0px 0px 1.5rem; padding: 0px; max-width: 100%; clear: both; min-height: 1em; overflow-wrap: break-word; text-rendering: optimizeLegibility;"><span style="font-size: 12pt; color: rgb(51, 51, 51); font-family: -apple-system-font;">也就是说：emptyDir Volume 的生命周期与 Pod 一致。 <span style="font-size: 16px; color: rgb(51, 51, 51); font-family: -apple-system-font;">Pod 中的所有容器都可以共享 Volume，它们可以指定各自的 mount 路径。下面通过例子来实践 emptyDir，配置文件如下：</span></span></div><div style="font-size: 19.2px; margin: 0px 0px 1.5rem; padding: 0px; max-width: 100%; clear: both; min-height: 1em; overflow-wrap: break-word; text-rendering: optimizeLegibility;"><span style="font-size: 12pt; color: rgb(51, 51, 51); font-family: -apple-system-font;"><img src="管理存储资源_files/Image.png" type="image/png" data-filename="Image.png" style="font-family: -apple-system-font; font-size: 12pt; color: rgb(51, 51, 51);" width="522"/></span></div><div style="font-size: 19.2px; margin: 0px 0px 1.5rem; padding: 0px; max-width: 100%; clear: both; min-height: 1em; overflow-wrap: break-word; text-rendering: optimizeLegibility;"><span style="font-size: 12pt;"><span style="font-size: 16px; text-rendering: optimizeLegibility; color: rgb(51, 51, 51); font-family: -apple-system-font; line-height: 28.8px;">这里我们模拟了一个 producer-consumer 场景。Pod 有两个容器 </span><span style="font-size: 16px; text-rendering: optimizeLegibility; color: rgb(51, 51, 51); font-family: -apple-system-font; line-height: 28.8px;">producer</span><span style="font-size: 16px; text-rendering: optimizeLegibility; color: rgb(51, 51, 51); font-family: -apple-system-font; line-height: 28.8px;">和 </span><span style="font-size: 16px; text-rendering: optimizeLegibility; color: rgb(51, 51, 51); font-family: -apple-system-font; line-height: 28.8px;">consumer</span><span style="font-size: 16px; text-rendering: optimizeLegibility; color: rgb(51, 51, 51); font-family: -apple-system-font; line-height: 28.8px;">，它们共享一个 Volume。</span><span style="font-size: 16px; text-rendering: optimizeLegibility; color: rgb(51, 51, 51); font-family: -apple-system-font; line-height: 28.8px;">producer</span><span style="font-size: 16px; text-rendering: optimizeLegibility; color: rgb(51, 51, 51); font-family: -apple-system-font; line-height: 28.8px;"> 负责往 Volume 中写数据，</span><span style="font-size: 16px; text-rendering: optimizeLegibility; color: rgb(51, 51, 51); font-family: -apple-system-font; line-height: 28.8px;">consumer</span><span style="font-size: 16px; text-rendering: optimizeLegibility; color: rgb(51, 51, 51); font-family: -apple-system-font; line-height: 28.8px;"> 则是从 Volume 读取数据。</span></span></div><div style="font-size: 19.2px; margin-bottom: 1.5rem; text-rendering: optimizeLegibility;"><span style="font-size: 16px; text-rendering: optimizeLegibility; color: rgb(51, 51, 51); font-family: -apple-system-font; line-height: 28.8px;">① 文件最底部 </span><span style="font-size: 16px; text-rendering: optimizeLegibility; color: rgb(51, 51, 51); font-family: -apple-system-font; line-height: 28.8px;">volumes</span><span style="font-size: 16px; text-rendering: optimizeLegibility; color: rgb(51, 51, 51); font-family: -apple-system-font; line-height: 28.8px;"> 定义了一个 </span><span style="font-size: 16px; text-rendering: optimizeLegibility; color: rgb(51, 51, 51); font-family: -apple-system-font; line-height: 28.8px;">emptyDir</span><span style="font-size: 16px; text-rendering: optimizeLegibility; color: rgb(51, 51, 51); font-family: -apple-system-font; line-height: 28.8px;"> 类型的 Volume </span><span style="font-size: 16px; text-rendering: optimizeLegibility; color: rgb(51, 51, 51); font-family: -apple-system-font; line-height: 28.8px;">shared-volume</span><span style="font-size: 16px; text-rendering: optimizeLegibility; color: rgb(51, 51, 51); font-family: -apple-system-font; line-height: 28.8px;">。</span></div><div style="font-size: 19.2px; margin-bottom: 1.5rem; text-rendering: optimizeLegibility;"><span style="font-size: 16px; text-rendering: optimizeLegibility; color: rgb(51, 51, 51); font-family: -apple-system-font; line-height: 28.8px;">② </span><span style="font-size: 16px; text-rendering: optimizeLegibility; color: rgb(51, 51, 51); font-family: -apple-system-font; line-height: 28.8px;">producer</span><span style="font-size: 16px; text-rendering: optimizeLegibility; color: rgb(51, 51, 51); font-family: -apple-system-font; line-height: 28.8px;"> 容器将 </span><span style="font-size: 16px; text-rendering: optimizeLegibility; color: rgb(51, 51, 51); font-family: -apple-system-font; line-height: 28.8px;">shared-volume</span><span style="font-size: 16px; text-rendering: optimizeLegibility; color: rgb(51, 51, 51); font-family: -apple-system-font; line-height: 28.8px;"> mount 到 </span><span style="font-size: 16px; text-rendering: optimizeLegibility; color: rgb(51, 51, 51); font-family: -apple-system-font; line-height: 28.8px;">/producer_dir</span><span style="font-size: 16px; text-rendering: optimizeLegibility; color: rgb(51, 51, 51); font-family: -apple-system-font; line-height: 28.8px;"> 目录。</span></div><div style="font-size: 19.2px; margin-bottom: 1.5rem; text-rendering: optimizeLegibility;"><span style="font-size: 16px; text-rendering: optimizeLegibility; color: rgb(51, 51, 51); font-family: -apple-system-font; line-height: 28.8px;">③ </span><span style="font-size: 16px; text-rendering: optimizeLegibility; color: rgb(51, 51, 51); font-family: -apple-system-font; line-height: 28.8px;">producer</span><span style="font-size: 16px; text-rendering: optimizeLegibility; color: rgb(51, 51, 51); font-family: -apple-system-font; line-height: 28.8px;"> 通过 </span><span style="font-size: 16px; text-rendering: optimizeLegibility; color: rgb(51, 51, 51); font-family: -apple-system-font; line-height: 28.8px;">echo</span><span style="font-size: 16px; text-rendering: optimizeLegibility; color: rgb(51, 51, 51); font-family: -apple-system-font; line-height: 28.8px;"> 将数据写到文件 </span><span style="font-size: 16px; text-rendering: optimizeLegibility; color: rgb(51, 51, 51); font-family: -apple-system-font; line-height: 28.8px;">hello</span><span style="font-size: 16px; text-rendering: optimizeLegibility; color: rgb(51, 51, 51); font-family: -apple-system-font; line-height: 28.8px;"> 里。</span></div><div style="font-size: 19.2px; margin-bottom: 1.5rem; text-rendering: optimizeLegibility;"><span style="font-size: 16px; text-rendering: optimizeLegibility; color: rgb(51, 51, 51); font-family: -apple-system-font; line-height: 28.8px;">④ </span><span style="font-size: 16px; text-rendering: optimizeLegibility; color: rgb(51, 51, 51); font-family: -apple-system-font; line-height: 28.8px;">consumer</span><span style="font-size: 16px; text-rendering: optimizeLegibility; color: rgb(51, 51, 51); font-family: -apple-system-font; line-height: 28.8px;"> 容器将 </span><span style="font-size: 16px; text-rendering: optimizeLegibility; color: rgb(51, 51, 51); font-family: -apple-system-font; line-height: 28.8px;">shared-volume</span><span style="font-size: 16px; text-rendering: optimizeLegibility; color: rgb(51, 51, 51); font-family: -apple-system-font; line-height: 28.8px;"> mount 到 </span><span style="font-size: 16px; text-rendering: optimizeLegibility; color: rgb(51, 51, 51); font-family: -apple-system-font; line-height: 28.8px;">/consumer_dir</span><span style="font-size: 16px; text-rendering: optimizeLegibility; color: rgb(51, 51, 51); font-family: -apple-system-font; line-height: 28.8px;"> 目录。</span></div><div style="font-size: 19.2px; margin: 0px 0px 1.5rem; padding: 0px; max-width: 100%; clear: both; min-height: 1em; overflow-wrap: break-word; text-rendering: optimizeLegibility;"><span style="font-size: 16px; text-rendering: optimizeLegibility; color: rgb(51, 51, 51); font-family: -apple-system-font; line-height: 28.8px;">⑤ </span><span style="font-size: 16px; text-rendering: optimizeLegibility; color: rgb(51, 51, 51); font-family: -apple-system-font; line-height: 28.8px;">consumer</span><span style="font-size: 16px; text-rendering: optimizeLegibility; color: rgb(51, 51, 51); font-family: -apple-system-font; line-height: 28.8px;"> 通过 </span><span style="font-size: 16px; text-rendering: optimizeLegibility; color: rgb(51, 51, 51); font-family: -apple-system-font; line-height: 28.8px;">cat</span><span style="font-size: 16px; text-rendering: optimizeLegibility; color: rgb(51, 51, 51); font-family: -apple-system-font; line-height: 28.8px;"> 从文件 </span><span style="font-size: 16px; text-rendering: optimizeLegibility; color: rgb(51, 51, 51); font-family: -apple-system-font; line-height: 28.8px;">hello</span><span style="font-size: 16px; text-rendering: optimizeLegibility; color: rgb(51, 51, 51); font-family: -apple-system-font; line-height: 28.8px;"> 读数据。</span></div><div style="font-size: 19.2px; margin: 0px 0px 1.5rem; padding: 0px; max-width: 100%; clear: both; min-height: 1em; overflow-wrap: break-word; text-rendering: optimizeLegibility;"><span style="font-size: 16px; letter-spacing: 0.034em; color: rgb(51, 51, 51); font-family: -apple-system-font;">emptyDir 是 Host 上创建的临时目录，其优点是能够方便地为 Pod 中的容器提供共享存储，不需要额外的配置。但它不具备持久性，如果 Pod 不存在了，emptyDir 也就没有了。根据这个特性，emptyDir 特别适合 Pod 中的容器需要临时共享存储空间的场景，比如前面的生产者消费者用例。</span></div><div style="text-align: left; margin: 5px 0px 0px; padding: 10px; max-width: 100%; box-sizing: border-box; overflow-wrap: break-word; border-style: none none none solid; border-color: rgb(0, 88, 156); box-shadow: rgb(153, 153, 153) 1px 1px 2px; border-left-width: 10px; background-color: rgb(243, 243, 243);"><font style="font-size: 14pt;"><span style="font-size: 14pt; color: rgb(168, 168, 168); font-weight: bold;">hostPath Volume</span></font></div><div style="font-size: 19.2px; margin: 0px 0px 1.5rem; padding: 0px; max-width: 100%; clear: both; min-height: 1em; overflow-wrap: break-word; text-rendering: optimizeLegibility;"><div style="overflow-wrap:break-word;hyphens:auto;"><div style="background-color:rgb(255, 255, 255);"><div style="overflow: hidden; font-size: 17px; overflow-wrap: break-word; text-align: justify;"><div style="margin: 0px 0px 1.5rem; padding: 0px; max-width: 100%; clear: both; min-height: 1em; overflow-wrap: break-word; font-size: 19.2px; text-rendering: optimizeLegibility;"><span style="font-size: 16px; color: rgb(51, 51, 51); font-family: -apple-system-font;-evernote-webclip:true;">hostPath Volume 的作用是将 Docker Host 文件系统中已经存在的目录 mount 给 Pod 的容器。大部分应用都不会使用 hostPath Volume，因为这实际上增加了 Pod 与节点的耦合，限制了 Pod 的使用。不过那些需要访问 Kubernetes 或 Docker 内部数据（配置文件和二进制库）的应用则需要使用 hostPath。</span></div><div style="margin: 0px 0px 1.5rem; padding: 0px; max-width: 100%; clear: both; min-height: 1em; overflow-wrap: break-word; font-size: 19.2px; text-rendering: optimizeLegibility;"><span style="font-size: 16px;-evernote-webclip:true;"><span style="font-size: 16px; color: rgb(51, 51, 51); font-family: -apple-system-font;">看下面是 Volume 的相关部分：</span></span></div><div style="margin: 0px 0px 1.5rem; padding: 0px; max-width: 100%; clear: both; min-height: 1em; overflow-wrap: break-word; font-size: 19.2px; text-rendering: optimizeLegibility;"><span style="max-width: 100%; clear: both; min-height: 1em; overflow-wrap: break-word; font-size: 16px; text-rendering: optimizeLegibility; color: rgb(51, 51, 51); font-family: -apple-system-font;"><img src="管理存储资源_files/Image [1].png" type="image/png" data-filename="Image.png" style="font-family: -apple-system-font; font-size: 12pt; color: rgb(51, 51, 51);" width="478"/></span></div><div style="margin: 0px 0px 1.5rem; padding: 0px; max-width: 100%; clear: both; min-height: 1em; overflow-wrap: break-word; font-size: 19.2px; text-rendering: optimizeLegibility;"><span style="font-size: 16px; text-rendering: optimizeLegibility; color: rgb(51, 51, 51); line-height: 28.8px;">这里定义了三个 hostPath volume </span><span style="font-size: 16px; text-rendering: optimizeLegibility; color: rgb(51, 51, 51); line-height: 28.8px;">k8s</span><span style="font-size: 16px; text-rendering: optimizeLegibility; color: rgb(51, 51, 51); line-height: 28.8px;">、</span><span style="font-size: 16px; text-rendering: optimizeLegibility; color: rgb(51, 51, 51); line-height: 28.8px;">certs</span><span style="font-size: 16px; text-rendering: optimizeLegibility; color: rgb(51, 51, 51); line-height: 28.8px;"> 和 </span><span style="font-size: 16px; text-rendering: optimizeLegibility; color: rgb(51, 51, 51); line-height: 28.8px;">pki</span><span style="font-size: 16px; text-rendering: optimizeLegibility; color: rgb(51, 51, 51); line-height: 28.8px;">，分别对应 Host 目录 </span><span style="font-size: 16px; text-rendering: optimizeLegibility; color: rgb(51, 51, 51); line-height: 28.8px;">/etc/kubernetes</span><span style="font-size: 16px; text-rendering: optimizeLegibility; color: rgb(51, 51, 51); line-height: 28.8px;">、</span><span style="font-size: 16px; text-rendering: optimizeLegibility; color: rgb(51, 51, 51); line-height: 28.8px;">/etc/ssl/certs</span><span style="font-size: 16px; text-rendering: optimizeLegibility; color: rgb(51, 51, 51); line-height: 28.8px;"> 和 </span><span style="font-size: 16px; text-rendering: optimizeLegibility; color: rgb(51, 51, 51); line-height: 28.8px;">/etc/pki</span><span style="font-size: 16px; text-rendering: optimizeLegibility; color: rgb(51, 51, 51); line-height: 28.8px;">。</span></div><div style="margin: 0px 0px 1.5rem; padding: 0px; max-width: 100%; clear: both; min-height: 1em; overflow-wrap: break-word; font-size: 19.2px; text-rendering: optimizeLegibility;"><span style="font-size: 16px; text-rendering: optimizeLegibility; color: rgb(51, 51, 51); line-height: 28.8px;">如果 Pod 被销毁了，hostPath 对应的目录也还会被保留，从这点看，hostPath 的持久性比 emptyDir 强。不过一旦 Host 崩溃，hostPath 也就没法访问了。</span></div><div style="text-align: left; margin: 5px 0px 0px; padding: 10px; max-width: 100%; box-sizing: border-box; overflow-wrap: break-word; border-style: none none none solid; border-color: rgb(0, 88, 156); box-shadow: rgb(153, 153, 153) 1px 1px 2px; border-left-width: 10px; background-color: rgb(243, 243, 243);"><span style="font-size: 13pt;">外部 Storage Provider</span></div><div style="margin: 0px 0px 1.5rem; padding: 0px; max-width: 100%; clear: both; min-height: 1em; overflow-wrap: break-word; font-size: 19.2px; text-rendering: optimizeLegibility;"><div style="overflow-wrap:break-word;hyphens:auto;"><div style="background-color:rgb(255, 255, 255);"><div style="overflow: hidden; font-size: 17px; overflow-wrap: break-word; text-align: justify;"><div style="margin: 0px 0px 1.5rem; padding: 0px; max-width: 100%; clear: both; min-height: 1em; overflow-wrap: break-word; font-size: 19.2px; text-rendering: optimizeLegibility;"><span style="font-size: 16px; color: rgb(51, 51, 51); font-family: -apple-system-font;">如果 Kubernetes 部署在诸如 AWS、GCE、Azure 等公有云上，可以直接使用云硬盘作为 Volume，下面是 AWS Elastic Block Store 的例子：</span></div><div style="margin: 0px 0px 1.5rem; padding: 0px; max-width: 100%; clear: both; min-height: 1em; overflow-wrap: break-word; font-size: 19.2px; text-rendering: optimizeLegibility;"><span style="font-size: 16px; color: rgb(51, 51, 51); font-family: -apple-system-font;"><img src="管理存储资源_files/Image [2].png" type="image/png" data-filename="Image.png" style="font-family: -apple-system-font; font-size: 12pt; color: rgb(51, 51, 51);" width="498"/></span></div></div></div></div><div><span style="max-width: 100%; clear: both; min-height: 1em; overflow-wrap: break-word; font-size: 16px; text-rendering: optimizeLegibility;"><span style="font-size: 16px; text-rendering: optimizeLegibility; color: rgb(51, 51, 51); font-family: -apple-system-font; line-height: 28.8px;">要在 Pod 中使用 ESB volume，必须先在 AWS 中创建，然后通过 volume-id 引用。其他云硬盘的使用方法可参考各公有云厂商的官方文档。</span></span></div></div><div style="margin: 0px 0px 1.5rem; padding: 0px; max-width: 100%; clear: both; min-height: 1em; overflow-wrap: break-word; font-size: 19.2px; text-rendering: optimizeLegibility;"><span style="font-size: 16px; text-rendering: optimizeLegibility; color: rgb(51, 51, 51); font-family: -apple-system-font; line-height: 28.8px;">Kubernetes Volume 也可以使用主流的分布式存，比如 Ceph、GlusterFS 等，下面是 Ceph 的例子：</span></div><div style="margin: 0px 0px 1.5rem; padding: 0px; max-width: 100%; clear: both; min-height: 1em; overflow-wrap: break-word; font-size: 19.2px; text-rendering: optimizeLegibility;"><span style="font-size: 16px; text-rendering: optimizeLegibility; color: rgb(51, 51, 51); font-family: -apple-system-font; line-height: 28.8px;"><img src="管理存储资源_files/Image [3].png" type="image/png" data-filename="Image.png" style="font-family: -apple-system-font; font-size: 12pt; color: rgb(51, 51, 51);" width="507"/></span></div></div></div></div><div><span style="font-size: 16px;"><span style="font-size: 16px; text-rendering: optimizeLegibility; color: rgb(51, 51, 51); font-family: -apple-system-font; line-height: 28.8px;">Ceph 文件系统的 </span><span style="font-size: 16px; text-rendering: optimizeLegibility; color: rgb(51, 51, 51); font-family: -apple-system-font; line-height: 28.8px;">/some/path/in/side/cephfs</span><span style="font-size: 16px; text-rendering: optimizeLegibility; color: rgb(51, 51, 51); font-family: -apple-system-font; line-height: 28.8px;"> 目录被 mount 到容器路径 /test-ceph。</span></span></div></div><div style="font-size: 19.2px; margin: 0px 0px 1.5rem; padding: 0px; max-width: 100%; clear: both; min-height: 1em; overflow-wrap: break-word; text-rendering: optimizeLegibility;"></div><div style="font-size: 19.2px; margin: 0px 0px 1.5rem; padding: 0px; max-width: 100%; clear: both; min-height: 1em; overflow-wrap: break-word; text-rendering: optimizeLegibility;"><span style="font-size: 16px;"><span style="font-size: 16px; text-rendering: optimizeLegibility;"><span style="font-size: 16px; text-rendering: optimizeLegibility; color: rgb(51, 51, 51); font-family: -apple-system-font; line-height: 28.8px;">相对于 emptyDir 和 hostPath，这些 Volume 类型的最大特点就是不依赖 Kubernetes。Volume 的底层基础设施由独立的存储系统管理，与 Kubernetes 集群是分离的。数据被持久化后，即使整个 Kubernetes 崩溃也不会受损。</span></span></span></div><div style="margin-bottom: 1.5rem; font-size: 19.2px; text-rendering: optimizeLegibility;"><span style="font-size: 16px; text-rendering: optimizeLegibility; color: rgb(51, 51, 51); font-family: -apple-system-font; line-height: 28.8px;">当然，运维这样的存储系统通常不是项简单的工作，特别是对可靠性、高可用和扩展性有较高要求时。</span></div><div style="font-size: 19.2px; margin: 0px 0px 1.5rem; padding: 0px; max-width: 100%; clear: both; min-height: 1em; overflow-wrap: break-word; text-rendering: optimizeLegibility;"><span style="font-size: 16px; text-rendering: optimizeLegibility; color: rgb(51, 51, 51); font-family: -apple-system-font; line-height: 28.8px;">Volume 提供了非常好的数据持久化方案，不过在可管理性上还有不足。</span></div></div></div></div><div style="font-size: 19.2px;"><br/></div><div style="text-align: left; margin: 5px 0px 0px; padding: 10px; max-width: 100%; box-sizing: border-box; overflow-wrap: break-word; border-style: none none none solid; border-color: rgb(0, 88, 156); box-shadow: rgb(153, 153, 153) 1px 1px 2px; border-left-width: 10px; background-color: rgb(243, 243, 243);"><font style="font-size: 14pt;"><span style="font-size: 14pt; color: rgb(168, 168, 168); font-weight: bold;">PV &amp; PVC</span></font></div><div style="font-size: 19.2px;"><div style="overflow-wrap:break-word;hyphens:auto;"><div style="background-color:rgb(255, 255, 255);"><div style="overflow: hidden; font-size: 17px; overflow-wrap: break-word; text-align: justify;"><div style="margin: 0px 0px 1.5rem; padding: 0px; max-width: 100%; clear: both; min-height: 1em; overflow-wrap: break-word; font-size: 19.2px; text-rendering: optimizeLegibility;"><span style="font-size: 16px; text-rendering: optimizeLegibility; color: rgb(51, 51, 51); font-family: -apple-system-font; line-height: 28.8px;">Volume 提供了非常好的数据持久化方案，不过在可管理性上还有不足。</span></div><div style="margin: 0px 0px 1.5rem; padding: 0px; max-width: 100%; clear: both; min-height: 1em; overflow-wrap: break-word; font-size: 19.2px; text-rendering: optimizeLegibility;"><span style="font-size: 16px; letter-spacing: 0.034em; color: rgb(51, 51, 51); font-family: -apple-system-font;">拿前面 AWS EBS 的例子来说，要使用 Volume，Pod 必须事先知道如下信息：</span></div><ol style="margin-left: 2rem;"><li><div style="margin-top: 1em; margin-bottom: 1em;"><span style="font-size: 16px; color: rgb(51, 51, 51); font-family: -apple-system-font;-en-paragraph:true;">当前 Volume 来自 AWS EBS。</span></div></li><li><div style="margin-top: 1em; margin-bottom: 1em;"><span style="font-size: 16px; color: rgb(51, 51, 51); font-family: -apple-system-font;-en-paragraph:true;">EBS Volume 已经提前创建，并且知道确切的 volume-id。</span></div></li></ol><div style="margin-bottom: 1.5rem; font-size: 19.2px; text-rendering: optimizeLegibility;"><span style="font-size: 16px; text-rendering: optimizeLegibility; color: rgb(51, 51, 51); font-family: -apple-system-font; line-height: 28.8px;">Pod 通常是由应用的开发人员维护，而 Volume 则通常是由存储系统的管理员维护。开发人员要获得上面的信息：</span></div><ol style="margin-left: 2rem;"><li><div style="margin-top: 1em; margin-bottom: 1em;"><span style="font-size: 16px; color: rgb(51, 51, 51); font-family: -apple-system-font;-en-paragraph:true;">要么询问管理员。</span></div></li><li><div style="margin-top: 1em; margin-bottom: 1em;"><span style="font-size: 16px; color: rgb(51, 51, 51); font-family: -apple-system-font;-en-paragraph:true;">要么自己就是管理员。</span></div></li></ol><div style="margin-bottom: 1.5rem; font-size: 19.2px; text-rendering: optimizeLegibility;"><span style="font-size: 16px; text-rendering: optimizeLegibility; color: rgb(51, 51, 51); font-family: -apple-system-font; line-height: 28.8px;">这样就带来一个管理上的问题：应用开发人员和系统管理员的职责耦合在一起了。如果系统规模较小或者对于开发环境这样的情况还可以接受。但当集群规模变大，特别是对于生成环境，考虑到效率和安全性，这就成了必须要解决的问题。</span></div><div style="margin-bottom: 1.5rem; font-size: 19.2px; text-rendering: optimizeLegibility;"><span style="font-size: 16px; text-rendering: optimizeLegibility; color: rgb(51, 51, 51); font-family: -apple-system-font; line-height: 28.8px;">Kubernetes 给出的解决方案是 PersistentVolume 和 PersistentVolumeClaim。</span></div><div style="margin-bottom: 1.5rem; font-size: 19.2px; text-rendering: optimizeLegibility;"><span style="font-size: 16px; text-rendering: optimizeLegibility;"><span style="font-size: 16px; color: rgb(255, 0, 0); font-family: -apple-system-font; font-weight: bold; line-height: 28.8px;">PersistentVolume (PV)</span></span> <span style="font-size: 16px; text-rendering: optimizeLegibility; color: rgb(51, 51, 51); font-family: -apple-system-font; line-height: 28.8px;">是外部存储系统中的一块存储空间，由管理员创建和维护。与 Volume 一样，PV 具有持久性，生命周期独立于 Pod。</span></div><div style="margin-bottom: 1.5rem; font-size: 19.2px; text-rendering: optimizeLegibility;"><span style="font-size: 16px; text-rendering: optimizeLegibility;"><span style="font-size: 16px; color: rgb(255, 0, 0); font-family: -apple-system-font; font-weight: bold; line-height: 28.8px;">PersistentVolumeClaim (PVC)</span></span> <span style="font-size: 16px; text-rendering: optimizeLegibility; color: rgb(51, 51, 51); font-family: -apple-system-font; line-height: 28.8px;">是对 PV 的申请 (Claim)。PVC 通常由普通用户创建和维护。需要为 Pod 分配存储资源时，用户可以创建一个 PVC，指明存储资源的容量大小和访问模式（比如只读）等信息，Kubernetes 会查找并提供满足条件的 PV。</span></div><div style="margin-bottom: 1.5rem; font-size: 19.2px; text-rendering: optimizeLegibility;"><span style="font-size: 16px; text-rendering: optimizeLegibility; color: rgb(51, 51, 51); font-family: -apple-system-font; line-height: 28.8px;">有了 PersistentVolumeClaim，用户只需要告诉 Kubernetes 需要什么样的存储资源，而不必关心真正的空间从哪里分配，如何访问等底层细节信息。这些 Storage Provider 的底层信息交给管理员来处理，只有管理员才应该关心创建 PersistentVolume 的细节信息。</span></div><div style="margin: 0px 0px 1.5rem; padding: 0px; max-width: 100%; clear: both; min-height: 1em; overflow-wrap: break-word; font-size: 19.2px; text-rendering: optimizeLegibility;"><span style="font-size: 16px; text-rendering: optimizeLegibility; color: rgb(51, 51, 51); font-family: -apple-system-font; line-height: 28.8px;">Kubernetes 支持多种类型的 PersistentVolume，比如 AWS EBS、Ceph、NFS 等，完整列表请参考：</span></div><div style="margin: 0px 0px 1.5rem; padding: 0px; max-width: 100%; clear: both; min-height: 1em; overflow-wrap: break-word; font-size: 19.2px; text-rendering: optimizeLegibility;"><a href="https://kubernetes.io/docs/concepts/storage/persistent-volumes/#types-of-persistent-volumes" style="font-size: 19.2px; letter-spacing: 0.034em; font-family: -apple-system-font;">https://kubernetes.io/docs/concepts/storage/persistent-volumes/#types-of-persistent-volumes</a></div></div></div></div><div><br/></div></div></div><div style="font-size: 19.2px; margin: 0px 0px 1.5rem; padding: 0px; max-width: 100%; box-sizing: inherit; clear: both; min-height: 1em; overflow-wrap: break-word; text-rendering: optimizeLegibility;"><br/></div></div></div></div></div></div><div><br/></div></span>
</div></body></html> 