<html>
<head>
  <title>Evernote Export</title>
  <basefont face="微软雅黑" size="2" />
  <meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
  <meta name="exporter-version" content="YXBJ Windows/600240 (zh-CN, DDL); Windows/10.0.0 (Win64);"/>
  <style>
    body, td {
      font-family: 微软雅黑;
      font-size: 10pt;
    }
  </style>
</head>
<body>
<a name="753"/>

<div>
<span><div><div style="text-align: center; margin: 0px; padding: 0px; clear: both; min-height: 1em; max-width: 100%; box-sizing: border-box; overflow-wrap: break-word;"><span style="clear: both; min-height: 1em; max-width: 100%; overflow-wrap: break-word; letter-spacing: 0.442px; font-size: 18.6667px; background-color: rgb(0, 88, 156); color: rgb(255, 255, 255); font-family: -apple-system-font, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif;">第四篇</span><span style="clear: both; min-height: 1em; max-width: 100%; overflow-wrap: break-word; font-size: 16pt; letter-spacing: 0.034em;">neutron</span><span style="clear: both; min-height: 1em; max-width: 100%; overflow-wrap: break-word; font-size: 16pt; letter-spacing: 0.034em;">— 网络实践</span></div><div><br/></div><div><span style="letter-spacing: 0.034em; font-size: 14pt; color: rgb(54, 101, 238); font-family: -apple-system-font; font-weight: bold;-evernote-webclip:true;">一、虚拟机获取 ip：</span></div><div style="box-sizing: border-box; margin: 0px; padding: 0px;"><br style="box-sizing: border-box; margin: 0px; padding: 0px; max-width: 100%; overflow-wrap: break-word;"/></div><div style="box-sizing: border-box; margin: 5px 0px 0px; padding: 10px; letter-spacing: 0.442px; orphans: 2; text-align: justify; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; max-width: 100%; overflow-wrap: break-word; border-style: none none none solid; border-color: rgb(0, 88, 156); box-shadow: rgb(153, 153, 153) 1px 1px 2px; border-left-width: 10px; background-color: rgb(243, 243, 243);"><font style="font-size: 12pt;"><span style="font-size: 12pt; color: rgb(168, 168, 168); font-family: 微软雅黑; font-variant-caps: normal; font-variant-ligatures: normal; font-weight: bold;">用 namspace 隔离 DHCP 服务</span></font></div><div><br/></div><div><span style="font-size: 12pt;">Neutron 通过 dnsmasq 提供 DHCP 服务，而 dnsmasq</span> <span style="font-size: 12pt;-en-paragraph:true;">通过 Linux Network Namespace </span><span style="font-size: 12pt;">独立的为每个 network 服务</span><span style="font-size: 12pt;-en-paragraph:true;">隔离</span></div><div style="margin-top: 1em; margin-bottom: 1em;"><span style="font-size: 12pt;">在二层网络上，VLAN 可以将一个物理交换机分割成几个独立的虚拟交换机。类似地，在三层网络上，</span><span style="font-size: 12pt; color: rgb(255, 70, 53); font-weight: bold;">Linux network namespace</span> <span style="font-size: 12pt;">可以将一个物理三层网络分割成几个独立的虚拟三层网络。</span></div><div style="margin-top: 1em; margin-bottom: 1em;"><span style="font-size: 12pt;">每个 namespace 都有自己独立的网络栈，包括 route table，firewall rule，network interface device 等。</span></div><div style="margin-top: 1em; margin-bottom: 1em;"><span style="font-size: 12pt;">Neutron 通过 namespace 为每个 network 提供独立的 DHCP 和路由服务，从而允许租户创建重叠的网络。如果没有 namespace，网络就不能重叠，这样就失去了很多灵活性。</span></div><div style="margin-top: 1em; margin-bottom: 1em;"><span style="font-size: 12pt;"><span style="font-size: 12pt;">每个 dnsmasq 进程都位于独立的 namespace, 命名为 qdhcp-&lt;network id&gt;，例如 flat_net：</span></span></div><div style="margin-top: 1em; margin-bottom: 1em;"><span style="font-size: 12pt;"><span style="font-size: 12pt;"><img src="neutron-02_files/Image.png" type="image/png" data-filename="Image.png" style="font-size: 12pt;" width="781"/></span></span></div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div><font style="font-size: 11pt;">ip netns list <span style="font-family: Monaco; color: rgb(51, 51, 51);">        命令列出所有的 namespace</span></font></div><div><span style="font-family: Monaco; font-size: 11pt; color: rgb(51, 51, 51);">ip netns exec &lt;network namespace name&gt; &lt;command&gt;        管理 namespace</span></div></div><div><br/></div><div><span style="-en-paragraph:true;"><font style="font-size: 12pt;"><span style="font-size: 12pt; font-weight: bold;-en-paragraph:true;">root namespace：</span></font></span></div><div><span style="-en-paragraph:true;"><span style="font-size: 12pt;">其实，宿主机本身也有一个 namespace，叫</span> <span style="font-size: 12pt; font-weight: bold;">root namespace</span><span style="font-size: 12pt;">，拥有所有物理和虚拟 interface device。物理 interface 只能位于 root namespace。</span></span></div><div style="margin-top: 1em; margin-bottom: 1em;"><span style="-en-paragraph:true;"><span style="font-size: 12pt;">新创建的 namespace 默认只有一个 loopback device。管理员可以将虚拟 interface，例如 bridge，tap 等设备添加到某个 namespace。</span></span></div><div style="margin-top: 1em; margin-bottom: 1em;"><span style="-en-paragraph:true;"><span style="font-size: 12pt;">对于 flat_net 的 DHCP 设备 tap19a0ed3d-fe，需要将其放到 namespace</span> <span style="font-size: 12pt;">qdhcp-7bf09be4-8653-4869-84f0-33494f238627 </span><span style="font-size: 12pt;">中，但这样会带来一个问题：tap19a0ed3d-fe 将无法直接与 root namespace 中的 bridge 设备 brqf153b42f-c3 连接。</span></span></div><div style="margin-top: 1em; margin-bottom: 1em;"></div><div style="margin-top: 1em; margin-bottom: 1em;"><span style="-en-paragraph:true;"><span style="font-size: 12pt; font-weight: bold;">Neutron 使用</span> <span style="font-size: 12pt; color: rgb(255, 70, 53); font-weight: bold;">veth pair</span> <span style="font-size: 12pt; font-weight: bold;">解决了这个问题。</span></span></div><div style="margin-top: 1em; margin-bottom: 1em;"><span style="-en-paragraph:true;"><span style="font-size: 12pt;">veth pair 是一种成对出现的特殊网络设备，它们象一根虚拟的网线，可用于连接两个 namespace。向 veth pair 一端输入数据，在另一端就能读到此数据。</span></span></div><div style="margin-top: 1em; margin-bottom: 1em;"><span style="-en-paragraph:true;"><span style="font-size: 12pt;">tap19a0ed3d-fe 与 ns-19a0ed3d-fe 就是一对 veth pair，它们将 qdhcp-f153b42f-c3a1-4b6c-8865-c09b5b2aa274 连接到 brqf153b42f-c3。</span></span></div><div><span style="-en-paragraph:true;"><span style="font-size: 12pt;">如下图所示：</span></span></div><div><img src="neutron-02_files/Image [1].png" type="image/png" data-filename="Image.png" style="font-size: 12pt;" width="642"/></div><div><br/></div><div><br/></div><div><span style="font-size: 12pt;">可以通过 ip netns exec qdhcp-7bf09be4-8653-4869-84f0-33494f238627 ip a命令查看ns-ba07bb93配置：</span></div><div><br/></div><div><img src="neutron-02_files/Image [2].png" type="image/png" data-filename="Image.png" width="922"/></div><div><br/></div><div style="box-sizing: border-box; margin: 0px; padding: 0px;"><br style="box-sizing: border-box; margin: 0px; padding: 0px; max-width: 100%; overflow-wrap: break-word;"/></div><div style="box-sizing: border-box; margin: 5px 0px 0px; padding: 10px; letter-spacing: 0.442px; orphans: 2; text-align: justify; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; max-width: 100%; overflow-wrap: break-word; border-style: none none none solid; border-color: rgb(0, 88, 156); box-shadow: rgb(153, 153, 153) 1px 1px 2px; border-left-width: 10px; background-color: rgb(243, 243, 243);"><font style="font-size: 12pt;"><span style="font-size: 12pt; color: rgb(168, 168, 168); font-family: 微软雅黑; font-variant-caps: normal; font-variant-ligatures: normal; font-weight: bold;">获取 dhcp IP 过程分析</span></font></div><div><br/></div><div><span style="font-size: 12pt;">在创建 instance 时，Neutron 会为其分配一个 port，里面包含了 MAC 和 IP 地址信息。这些信息会同步更新到 dnsmasq 的 host 文件。如下图所示：</span></div><div><img src="neutron-02_files/Image [3].png" type="image/png" data-filename="Image.png" width="739"/></div><div><br/></div><div><span style="font-size: 12pt;">同时 nova-compute 会设置虚机</span> <span style="font-size: 12pt;">VIF 的 MAC 地址。</span></div><div><img src="neutron-02_files/Image [4].png" type="image/png" data-filename="Image.png" width="911"/></div><div><img src="neutron-02_files/Image [5].png" type="image/png" data-filename="Image.png" width="911"/></div><div><br/></div><div>一切准备就绪，instance 获取 IP 的过程如下：</div><div><br/></div><div>1. vm 开机启动，发出 DHCPDISCOVER 广播，该广播消息在整个 net 中都可以被收到。</div><div><br/></div><div>2. 广播到达 veth tap19a0ed3d-fe，然后传送给 veth pair 的另一端 ns-19a0ed3d-fe。dnsmasq 在它上面监听，dnsmasq 检查其 host 文件，发现有对应项，于是dnsmasq 以  DHCPOFFER 消息将 IP（192.168.254.18）、子网掩码（255.255.255.0）、地址租用期限等信息发送给 vm。</div><div><br/></div><div>3. vm 发送 DHCPREQUEST 消息确认接受此 DHCPOFFER。</div><div><br/></div><div>4. dnsmasq 发送确认消息 DHCPACK，整个过程结束。</div><div><br/></div><div><span style="letter-spacing: 0.034em; font-size: 14pt; color: rgb(54, 101, 238); font-family: -apple-system-font; font-weight: bold;-evernote-webclip:true;">二、VXLAN简介：</span></div><div style="box-sizing: border-box; margin: 0px; padding: 0px;"><br style="box-sizing: border-box; margin: 0px; padding: 0px; max-width: 100%; overflow-wrap: break-word;"/></div><div style="box-sizing: border-box; margin: 5px 0px 0px; padding: 10px; letter-spacing: 0.442px; orphans: 2; text-align: justify; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; max-width: 100%; overflow-wrap: break-word; border-style: none none none solid; border-color: rgb(0, 88, 156); box-shadow: rgb(153, 153, 153) 1px 1px 2px; border-left-width: 10px; background-color: rgb(243, 243, 243);"><span style="font-size: 12pt; color: rgb(168, 168, 168); font-weight: bold;">overlay network概念：</span></div><div><br/></div><div><span style="font-size: 12pt;-en-paragraph:true;"><span style="font-size: 12pt;">overlay network 是指建立在其他网络上的网络。overlay network 中的节点可以看作通过虚拟（或逻辑）链路连接起来的。overlay network 在底层可能由若干物理链路组成，但对于节点，不需要关心这些底层实现。</span></span></div><div><br/></div><div><span style="font-size: 12pt;-en-paragraph:true;">例如 P2P 网络就是 overlay network，隧道也是。vxlan 和 gre 都是基于隧道技术实现的，它们也都是 overlay network。</span></div><div><br/></div><div><span style="font-size: 12pt;">目前 linux bridge 只支持 vxlan，不支持 gre；</span></div><div><span style="font-size: 12pt;">open vswitch 两者都支持。vxlan 与 gre 实现非常类似，而且 vxlan 用得较多，所以本教程只介绍 vxlan。</span></div><div><br/></div><div style="box-sizing: border-box; margin: 0px; padding: 0px;"><br style="box-sizing: border-box; margin: 0px; padding: 0px; max-width: 100%; overflow-wrap: break-word;"/></div><div style="box-sizing: border-box; margin: 5px 0px 0px; padding: 10px; letter-spacing: 0.442px; orphans: 2; text-align: justify; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; max-width: 100%; overflow-wrap: break-word; border-style: none none none solid; border-color: rgb(0, 88, 156); box-shadow: rgb(153, 153, 153) 1px 1px 2px; border-left-width: 10px; background-color: rgb(243, 243, 243);"><span style="font-size: 12pt;-en-paragraph:true;"><span style="font-size: 12pt; color: rgb(168, 168, 168); font-weight: bold;">VXLAN简介：</span></span></div><div style="margin-top: 1em; margin-bottom: 1em;"><span style="-en-paragraph:true;"><span style="font-size: 14pt; font-weight: bold;">VXLAN 为 Virtual eXtensible Local Area Network。</span><span style="font-size: 12pt;">正如名字所描述的，VXLAN 提供与 VLAN 相同的以太网二层服务，但拥有更强的扩展性和灵活性。与 VLAN 相比，</span></span></div><div style="margin-top: 1em; margin-bottom: 1em;"><span style="font-size: 12pt;-en-paragraph:true;"><span style="font-size: 12pt; font-weight: bold;">VXLAN 有下面几个优势：</span></span></div><div style="margin-top: 1em; margin-bottom: 1em;"><span style="-en-paragraph:true;"><span style="font-size: 11pt; font-weight: bold;">1. 支持更多的二层网段。</span></span></div><div style="margin-top: 1em; margin-bottom: 1em;"><span style="font-size: 11pt;">VLAN 使用 12-bit 标记 VLAN ID，最多支持 4094 个 VLAN，这对大型云部署会成为瓶颈。VXLAN 的 ID （VNI 或者 VNID）则用 24-bit 标记，支持 16777216 个二层网段。</span></div><div style="margin-top: 1em; margin-bottom: 1em;"><span style="-en-paragraph:true;"><span style="font-size: 11pt; font-weight: bold;">2. 能更好地利用已有的网络路径。</span></span></div><div style="margin-top: 1em; margin-bottom: 1em;"><span style="-en-paragraph:true;"><span style="font-size: 11pt;">VLAN 使用 Spanning Tree Protocol 避免环路，这会导致有一半的网络路径被 block 掉。VXLAN 的数据包是封装到 UDP 通过三层传输和转发的，可以使用所有的路径。</span></span></div><div style="margin-top: 1em; margin-bottom: 1em;"><span style="-en-paragraph:true;"><span style="font-size: 11pt; font-weight: bold;">3. 避免物理交换机 MAC 表耗尽。</span></span></div><div><span style="-en-paragraph:true;"><span style="font-size: 11pt;">由于采用隧道机制，TOR (Top on Rack) 交换机无需在 MAC 表中记录虚拟机的信息。</span></span></div><div><br/></div><div><br/></div><div><span style="-en-paragraph:true;"><font style="font-size: 12pt;"><span style="font-size: 12pt; font-weight: bold;">VXLAN 封装和包格式：</span></font></span></div><div style="margin-top: 1em; margin-bottom: 1em;"><span style="font-size: 11pt;-en-paragraph:true;">VXLAN 是将二层建立在三层上的网络。通过将二层数据封装到 UDP 的方式来扩展数据中心的二层网段数量。</span></div><div style="margin-top: 1em; margin-bottom: 1em;"><span style="font-size: 11pt;-en-paragraph:true;">VXLAN 是一种在现有物理网络设施中支持大规模多租户网络环境的解决方案。VXLAN 的传输协议是 IP + UDP。</span></div><div><span style="font-size: 11pt;-en-paragraph:true;">VXLAN 定义了一个 MAC-in-UDP 的封装格式。在原始的 Layer 2 网络包前加上 VXLAN header，然后放到 UDP 和 IP 包中。通过 MAC-in-UDP 封装，VXLAN 能够在 Layer 3 网络上建立起了一条 Layer 2 的隧道。</span></div><div><br/></div><div><span style="font-size: 11pt;">VXLAN 包的格式如下：</span></div><div><img src="neutron-02_files/Image [6].png" type="image/png" data-filename="Image.png" style="font-size: 11pt;" width="751"/></div><div><br/></div><div><span style="font-size: 11pt;">如上图所示，VXLAN 引入了 8-byte VXLAN header，其中 VNI 占 24-bit。VXLAN 和原始的 L2 frame 被封装</span><span style="font-size: 11pt;">到 UDP 包中。这 24-bit 的 VNI 用于标示不同的二层网段，能够支持 16777216 个 LAN。</span></div><div><br/></div><div><br/></div><div><span style="border-width: 0px; white-space: pre;"><font style="font-size: 14pt;"><span style="font-size: 14pt; color: rgb(51, 51, 51); font-weight: bold;">VXLAN Tunnel Endpoint</span></font></span></div><div><br/></div><div><span style="-en-paragraph:true;"><span style="font-size: 12pt;">VXLAN 使用</span> <span style="font-size: 12pt; color: rgb(255, 0, 0); font-weight: bold;">VXLAN tunnel endpoint (VTEP)</span> <span style="font-size: 12pt;">设备处理 VXLAN 的封装和解封。每个 VTEP 有一个 IP interface，配置了一个 IP 地址。VTEP 使用该 IP 封装 Layer 2 frame，并通过该 IP interface 传输和接收封装后的 VXLAN 数据包。</span></span></div><div><span style="font-size: 11pt;">下面是 VTEP 的示意图：</span></div><div><img src="neutron-02_files/Image [7].png" type="image/png" data-filename="Image.png" style="font-size: 11pt;" width="678"/></div><div><br/></div><div><span style="font-size: 11pt;">VXLAN 独立于底层的网络拓扑；反过来，两个 VTEP 之间的底层 IP 网络也独立于 VXLAN。VXLAN 数据包是根据外层的 IP header 路由的，该 header 将两端的 VTEP IP 作为源和目标 IP。</span></div><div><br/></div><div><br/></div><div style="box-sizing: border-box; margin: 0px; padding: 0px;"><br style="box-sizing: border-box; margin: 0px; padding: 0px; max-width: 100%; overflow-wrap: break-word;"/></div><div style="box-sizing: border-box; margin: 5px 0px 0px; padding: 10px; letter-spacing: 0.442px; orphans: 2; text-align: justify; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; max-width: 100%; overflow-wrap: break-word; border-style: none none none solid; border-color: rgb(0, 88, 156); box-shadow: rgb(153, 153, 153) 1px 1px 2px; border-left-width: 10px; background-color: rgb(243, 243, 243);"><font style="font-size: 12pt;"><span style="font-size: 12pt; color: rgb(168, 168, 168); font-weight: bold;">VXLAN 封装和转发包的过程，以及 Linux 对 VXLAN 的原生支持</span></font></div><div style="margin-top: 1em; margin-bottom: 1em;"><span style="-en-paragraph:true;"><span style="font-size: 14pt; font-weight: bold;">VXLAN 包转发流程</span></span></div><div style="margin-top: 1em; margin-bottom: 1em;"><span style="-en-paragraph:true;"><span style="font-size: 12pt;">VXLAN 在 VTEP 间建立隧道，通过 Layer 3 网络传输封装后的 Layer 2 数据。下面例子演示了数据如何在 VXLAN 上传输：</span></span></div><div style="margin-top: 1em; margin-bottom: 1em;"><span style="-en-paragraph:true;"><span style="font-size: 12pt;"><img src="neutron-02_files/Image [8].png" type="image/png" data-filename="Image.png" style="font-size: 12pt;" width="677"/></span></span></div><div style="margin-top: 1em; margin-bottom: 1em;"><span style="-en-paragraph:true;"><font style="font-size: 12pt;"><span style="font-size: 12pt;-en-paragraph:true;">图中 Host-A 和 Host-B 位于 VNI 10 的 VXLAN，通过 VTEP-1 和 VTEP-2 之间建立的 VXLAN 隧道通信。数据传输过程如下：</span></font></span></div><div style="margin-top: 1em; margin-bottom: 1em;"><span style="-en-paragraph:true;"><span style="font-size: 11pt;">1. Host-A 向 Host-B 发送数据时，Host-B 的 MAC 和 IP 作为数据包的目标 MAC 和 IP，Host-A 的 MAC 作为数据包的源 MAC 和 IP，然后通过 VTEP-1 将数据发送出去。</span></span></div><div style="margin-top: 1em; margin-bottom: 1em;"><span style="-en-paragraph:true;"><span style="font-size: 11pt;">2. VTEP-1 从自己维护的映射表中找到 MAC-B 对应的 VTEP-2，然后执行 VXLAN 封装，加上 VXLAN 头，UDP 头，以及外层 IP 和 MAC 头。此时的外层 IP 头，目标地址为 VTEP-2 的 IP，源地址为 VTEP-1 的 IP。同时由于下一跳是 Router-1，所以外层 MAC 头中目标地址为 Router-1 的 MAC。</span></span></div><div style="margin-top: 1em; margin-bottom: 1em;"><span style="-en-paragraph:true;"><span style="font-size: 11pt;">3. 数据包从 VTEP-1 发送出后，外部网络的路由器会依据外层 IP 头进行路由，最后到达与 VTEP-2 连接的路由器 Router-2。</span></span></div><div style="margin-top: 1em; margin-bottom: 1em;"><span style="-en-paragraph:true;"><span style="font-size: 11pt;">4. Router-2 将数据包发送给 VTEP-2。VTEP-2 负责解封数据包，依次去掉外层 MAC 头，外层 IP 头，UDP 头 和 VXLAN 头。VTEP-2 依据目标 MAC 地址将数据包发送给 Host-B。</span></span></div><div style="margin-top: 1em; margin-bottom: 1em;"><span style="font-size: 12pt;-en-paragraph:true;">上面的流程我们看到 VTEP 是 VXLAN 的最核心组件，负责数据的封装和解封。</span><span style="font-size: 12pt;">隧道也是建立在 VTEP 之间的，VTEP 负责数据的传送。</span></div><div style="margin-top: 1em; margin-bottom: 1em;"></div><div style="margin-top: 1em; margin-bottom: 1em;"><span style="font-size: 12pt;-en-paragraph:true;"><span style="font-size: 12pt; font-weight: bold;-en-paragraph:true;">VTEP 是如何提前获知 IP -- MAC -- VTEP 相关信息的呢？</span></span></div><div style="margin-top: 1em; margin-bottom: 1em;"><span style="font-size: 12pt;-en-paragraph:true;">答案是：</span></div><div style="margin-top: 1em; margin-bottom: 1em;"><span style="-en-paragraph:true;"><span style="font-size: 11pt;">1. Neutron 知道每一个 port 的状态和信息； port 保存了 IP，MAC 相关数据。</span></span></div><div style="margin-top: 1em; margin-bottom: 1em;"><span style="-en-paragraph:true;"><span style="font-size: 11pt;">2. instance 启动时，其 port 状态变化过程为：down -&gt; build -&gt; active。</span></span></div><div style="margin-top: 1em; margin-bottom: 1em;"><span style="-en-paragraph:true;"><span style="font-size: 11pt;">3. 每当 port 状态发生变化时，Neutron 都会通过 RPC 消息通知各节点上的 Neutron agent，使得 VTEP 能够更新 VM 和 port 的相关信息。</span></span></div><div style="margin-top: 1em; margin-bottom: 1em;"><span style="font-size: 12pt;-en-paragraph:true;">VTEP 可以根据这些信息判断出其他 Host 上都有哪些 VM，以及它们的 MAC 地址，这样就能直接与之通信，从而避免了不必要的隧道连接和广播。</span></div><div style="margin-top: 1em; margin-bottom: 1em;"></div><div style="margin-top: 1em; margin-bottom: 1em;"><span style="-en-paragraph:true;"><span style="border-width: 0px; white-space: pre;"><span style="font-size: 14pt; color: rgb(51, 51, 51); font-weight: bold;">Linux 对 VXLAN 的支持</span></span></span></div><div style="margin-top: 1em; margin-bottom: 1em;"><span style="font-size: 12pt;-en-paragraph:true;">VTEP 可以由专有硬件来实现，也可以使用纯软件实现。目前比较成熟的 VTEP 软件实现包括：</span></div><div style="margin-top: 1em; margin-bottom: 1em;"><span style="font-size: 12pt;-en-paragraph:true;">1. 带 VXLAN 内核模块的 Linux</span></div><div style="margin-top: 1em; margin-bottom: 1em;"><span style="font-size: 12pt;-en-paragraph:true;">2. Open vSwitch</span></div><div style="margin-top: 1em; margin-bottom: 1em;"><span style="font-size: 12pt;-en-paragraph:true;">我们先来看 Linux 如何支持 VXLAN</span></div><div style="margin-top: 1em; margin-bottom: 1em;"><span style="font-size: 12pt;-en-paragraph:true;"><img src="neutron-02_files/Image [9].png" type="image/png" data-filename="Image.png" style="font-size: 12pt;" width="691"/></span></div><div style="margin-top: 1em; margin-bottom: 1em;"><span style="font-size: 12pt;-en-paragraph:true;"><span style="font-size: 12pt;-en-paragraph:true;">实现方式：</span></span></div><div><span style="font-size: 12pt;">1. Linux vxlan 创建一个 UDP Socket，默认在 8472 端口监听。</span></div><div><br/></div><div><span style="font-size: 12pt;">2. Linux vxlan 在 UDP socket 上接收到 vxlan 包后，解包，然后根据其中的 vxlan ID 将它转给某个 vxlan interface，然后再通过它所连接的 linux bridge 转给虚机。</span></div><div><br/></div><div><span style="font-size: 12pt;">3. Linux vxlan 在收到虚机发来的数据包后，将其封装为多播 UDP 包，从网卡发出。</span></div><div><br/></div><div><br/></div><div><br/></div><div style="box-sizing: border-box; margin: 5px 0px 0px; padding: 10px; letter-spacing: 0.442px; orphans: 2; text-align: justify; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; max-width: 100%; overflow-wrap: break-word; border-style: none none none solid; border-color: rgb(0, 88, 156); box-shadow: rgb(153, 153, 153) 1px 1px 2px; border-left-width: 10px; background-color: rgb(243, 243, 243);"><span style="font-size: 12pt; color: rgb(168, 168, 168); font-weight: bold;">ML2 mechanism driver：</span> <span style="font-size: 12pt; color: rgb(168, 168, 168); font-weight: bold;">Linux Bridge 和 Open vSwitch</span></div><div><br/></div><div><span style="font-size: 12pt; font-weight: bold;">网卡分配示例：</span></div><div><img src="neutron-02_files/Image [10].png" type="image/png" data-filename="Image.png" style="font-weight: bold; font-size: 14pt;" width="471"/></div><ol style="margin-top: 15px; margin-bottom: 15px; border-width: 0px; font-size: 15px; white-space: normal;"><li><div><span style="font-size: 16px; color: rgb(51, 51, 51);">控制节点三个网卡（eth0, eth1, eth2），计算节点两网卡（eth0, eth1）。</span></div></li><li><div><span style="font-size: 16px; color: rgb(51, 51, 51);">合并 Management 和 API 网络，使用 eth0，IP 段为 192.168.104.0/24。</span></div></li><li><div><span style="font-size: 16px; color: rgb(51, 51, 51);">VM 网络使用 eht1。</span></div></li><li><div><span style="font-size: 16px; color: rgb(51, 51, 51);">控制节点的 eth2 与 External 网络连接，IP 段为 10.10.10.0/24。</span></div></li></ol><div><br/></div><div><span style="font-size: 14pt;-en-paragraph:true;"><span style="font-size: 14pt; font-weight: bold;">Linux Bridge ：</span></span></div><div><br/></div><div><img src="neutron-02_files/Image [11].png" type="image/png" data-filename="Image.png" style="font-weight: bold; font-size: 14pt;" width="922"/></div><div><br/></div><div><br/></div><div><span style="font-size: 14pt;-en-paragraph:true;"><span style="font-size: 14pt; font-weight: bold;">Open vSwitch：</span></span></div><div><img src="neutron-02_files/Image [12].png" type="image/png" data-filename="Image.png" style="font-weight: bold;" width="616"/></div><div><span style="font-size: 14pt; font-weight: bold;-en-paragraph:true;"><br/></span></div><div><span style="font-size: 14pt; font-weight: bold;-en-paragraph:true;">Open vSwitch 中的网络设备：</span></div><div><span style="font-size: 16px; border-width: 0px; font-weight: bold;">br-ex：</span>连接外部（external）网络的网桥。</div><div><span style="font-size: 16px; border-width: 0px; font-weight: bold;">br-int：</span>集成（integration）网桥，所有 instance 的虚拟网卡和其他虚拟网络设备都将连接到该网桥。</div><div><span style="font-size: 16px; border-width: 0px; font-weight: bold;">br-tun：</span>隧道（tunnel）网桥，基于隧道技术的 VxLAN 和 GRE 网络将使用该网桥进行通信。</div><div><span style="-en-paragraph:true;"><span style="font-size: 12pt; font-weight: bold;">tap interface：</span></span>命名为 tapXXXX。</div><div><span style="font-size: 12pt; font-weight: bold;">linux bridge：</span>命名为 qbrXXXX。</div><div><span style="font-size: 12pt; font-weight: bold;">veth pair：</span>命名为 qvbXXXX, qvoXXXX</div><div><span style="font-size: 12pt; font-weight: bold;">OVS integration bridge：</span>命名为 br-int。</div><div><span style="font-size: 12pt; font-weight: bold;">OVS patch ports：</span>命名为 int-br-ethX 和 phy-br-ethX（X 为 interface 的序号）。</div><div><span style="font-weight: bold;"><span style="font-size: 12pt; font-weight: bold;">OVS provider bridge</span>：</span>命名为 br-ethX（X 为 interface 的序号）。</div><div><span style="font-size: 12pt; font-weight: bold;">物理 interface：</span>命名为 ethX（X 为 interface 的序号）。</div><div><span style="font-size: 12pt; font-weight: bold;">OVS tunnel bridge：</span>命名为 br-tun。</div><div><br/></div><div style="box-sizing: border-box; margin: 0px; padding: 0px;"><br style="box-sizing: border-box; margin: 0px; padding: 0px; max-width: 100%; overflow-wrap: break-word;"/></div><div style="box-sizing: border-box; margin: 0px; padding: 0px;"><span style="letter-spacing: 0.034em; font-size: 14pt; color: rgb(54, 101, 238); font-family: -apple-system-font; font-weight: bold;-evernote-webclip:true;">三、三层网络介绍：</span></div><div style="box-sizing: border-box; margin: 5px 0px 0px; padding: 10px; letter-spacing: 0.442px; orphans: 2; text-align: justify; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; max-width: 100%; overflow-wrap: break-word; border-style: none none none solid; border-color: rgb(0, 88, 156); box-shadow: rgb(153, 153, 153) 1px 1px 2px; border-left-width: 10px; background-color: rgb(243, 243, 243);"><span style="font-size: 16px;"><span style="font-size: 16px; color: rgb(168, 168, 168); font-weight: bold;">虚拟机访问外网</span></span></div><div><br/></div><div><span style="font-size: 12pt;">（1）虚拟机中访问一个外网地址</span><span style="font-size: 12pt;">192.168.253.3</span><span style="font-size: 12pt;">，并用 traceroute 命令跟踪路由查看：</span></div><div><span style="font-size: 12pt;"><img src="neutron-02_files/Image [13].png" type="image/png" data-filename="Image.png" width="922"/></span></div><div><br/></div><div><span style="font-size: 12pt;">（2）根据网络拓扑，由于虚机访问外网要经过本网段的网关192.168.101.1，然后经过路由的外网接口转发出去，到达192.168.253.3</span></div><div><img src="neutron-02_files/Image [14].png" type="image/png" data-filename="Image.png" width="922"/></div><div><br/></div><div><span style="font-size: 12pt;">查看路由命名空间：</span></div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div><span style="font-family: Monaco; color: rgb(51, 51, 51);"><font style="font-size: 10pt;">ip netns list</font></span></div></div><div><img src="neutron-02_files/Image [15].png" type="image/png" data-filename="Image.png" width="592"/></div><div><br/></div><div><span style="font-size: 12pt;">（3）查看路由命名空间的网络配置，查到路由连接外网的端口和ip：</span></div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div><span style="font-family: Monaco; color: rgb(51, 51, 51);"><font style="font-size: 10pt;">ip netns exec qrouter-176bd7e0-6427-46a5-906a-be6a373a29a1 ip a</font></span></div></div><div><img src="neutron-02_files/Image [16].png" type="image/png" data-filename="Image.png" width="922"/></div><div><span style="font-size: 12pt;">路由上的外网端口正好接到外网网桥br-ex上：ovs-vsctl show 查看</span></div><div><img src="neutron-02_files/Image [17].png" type="image/png" data-filename="Image.png" width="519"/></div><div><br/></div><div><span style="font-size: 12pt;">（4）查看路由iptables NAT 转发规则，记录对私网做的SNAT</span></div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div><span style="font-size: 10pt; font-family: Monaco; color: rgb(51, 51, 51);">ip netns exec qrouter-176bd7e0-6427-46a5-906a-be6a373a29a1 iptables -t nat -L</span></div><div><span style="font-size: 10pt; font-family: Monaco; color: rgb(51, 51, 51);">ip netns exec qrouter-176bd7e0-6427-46a5-906a-be6a373a29a1 iptables -t nat -S</span></div></div><div><img src="neutron-02_files/Image [18].png" type="image/png" data-filename="Image.png" width="922"/></div><div><span style="font-size: 12pt;">规则解释： </span><span style="font-size: 12pt; font-weight: bold;">-A neutron-l3-agent-snat -o qg-8df29d32-d6 -j SNAT --to-source 192.168.253.65</span> <span style="font-size: 12pt;">记录了流入接口</span><span style="font-size: 12pt; font-weight: bold;">qg-8df29d32-d6</span> <span style="font-size: 12pt;">的数据包做</span><span style="font-size: 12pt; font-weight: bold;">SNAT（基于源地址转发），</span><span style="font-size: 12pt;"><span style="font-size: 12pt;">将源地址修改为</span><span style="font-size: 12pt;">192.168.253.65</span></span></div><div><br/></div><div><span style="font-size: 12pt;">（5）验证：</span></div><div><span style="font-size: 12pt;">在虚机 ping </span><span style="font-size: 12pt;">192.168.253.3 时，<span style="font-size: 12pt;"> 可以通过 tcpdump 分别观察 router 两个 interface 的 icmp 数据包来验证 SNAT 的行为：</span></span></div><div><span style="font-size: 12pt;">在路由qrouter-176bd7e0-6427-46a5-906a-be6a373a29a1，可查到私有网络的网关接口</span><span style="font-size: 12pt;">qr-7b56f58b-b5，并在路由中抓取<span style="font-size: 12pt;">网关接口的icmp包：</span></span></div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div><span style="font-family: Monaco; color: rgb(51, 51, 51);"><font style="font-size: 10pt;">ip netns exec qrouter-176bd7e0-6427-46a5-906a-be6a373a29a1 tcpdump -i qr-7b56f58b-b5 -n icmp</font></span></div></div><div><img src="neutron-02_files/Image [19].png" type="image/png" data-filename="Image.png" width="922"/></div><div><span style="font-size: 12pt;">在路由中，</span><span style="font-size: 12pt; color: rgb(51, 51, 51); font-family: Monaco;">抓取</span><span style="font-size: 12pt;">路由的外网接口</span><span style="font-size: 12pt; color: rgb(51, 51, 51); font-family: Monaco;">qg-8df29d32-d6<span style="font-size: 12pt; color: rgb(51, 51, 51); font-family: Monaco;">的icmp包：</span></span></div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div><span style="font-family: Monaco; color: rgb(51, 51, 51);"><font style="font-size: 10pt;">ip netns exec qrouter-176bd7e0-6427-46a5-906a-be6a373a29a1 tcpdump -i qg-8df29d32-d6 -n icmp</font></span></div></div><div><img src="neutron-02_files/Image [20].png" type="image/png" data-filename="Image.png" width="922"/></div><div><br/></div><div><br/></div><div style="box-sizing: border-box; margin: 5px 0px 0px; padding: 10px; letter-spacing: 0.442px; orphans: 2; text-align: justify; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; max-width: 100%; overflow-wrap: break-word; border-style: none none none solid; border-color: rgb(0, 88, 156); box-shadow: rgb(153, 153, 153) 1px 1px 2px; border-left-width: 10px; background-color: rgb(243, 243, 243);"><font style="font-size: 12pt;"><span style="font-size: 12pt; color: rgb(168, 168, 168); font-weight: bold;">外网访问虚机——floating ip原理</span></font></div><div><br/></div><div><span style="font-size: 12pt;">SNAT 让 instance 能够直接访问外网，但外网还不能直接访问 instance。因为 instance 没有外网 IP。这里 “直接访问 instance” 是指通信连接由外网发起，例如从外网 SSH 实例。</span></div><div><br/></div><div><span style="font-size: 12pt;">（1）首先将实例绑定浮动 ip</span><span style="font-size: 12pt;">192.168.253.66</span><span style="font-size: 12pt;">，</span> <span style="font-size: 12pt;">floating IP 是配置在 router 的外网 interface 上的，</span><span style="font-size: 12pt;">再查看 router 的 interface 配置：</span></div><div><img src="neutron-02_files/Image [21].png" type="image/png" data-filename="Image.png" width="922"/></div><div><span style="font-size: 12pt;">（2）在实例中ping 192.168.253.3 外网地址，在路由的</span><span style="font-size: 12pt; color: rgb(51, 51, 51); font-family: Monaco;">qr-7b56f58b-b5 接口上，实例访问外网ip，外网ip将数据包转发回实例ip；</span><span style="font-size: 12pt; color: rgb(51, 51, 51); font-family: Monaco;">但在路由的</span><span style="font-size: 12pt; color: rgb(51, 51, 51); font-family: Monaco;">qg-8df29d32-d6 接口上，始终是通过 floating IP 192.168.253.66 与外网通信。</span></div><div><img src="neutron-02_files/Image [22].png" type="image/png" data-filename="Image.png" width="922"/></div><div><span style="font-size: 12pt;">（3） 原因是在路由中iptables做了DNA T（基于目的地址转发），查看 router 的 NAT 规则：</span></div><div><img src="neutron-02_files/Image [23].png" type="image/png" data-filename="Image.png" style="font-size: 12pt;" width="922"/></div><div><span style="font-size: 12pt;">当 router 接收到从外网发来的包，如果目的地址是 floating IP 192.168.254.66，将目的地址修改为实例的 IP 192.168.101.3。这样外网的包就能送达到实例；</span></div><div><span style="-en-paragraph:true;"><span style="font-size: 12pt;">当实例发送数据到外网，源地址 192.168.101.3 将被修改为 floating IP 192.168.253.66；</span></span></div><div><br/></div><div><br/></div><div><br/></div><div><span style="font-size: 14pt; color: rgb(54, 101, 238); font-weight: bold;">四：neutron配置文件：</span></div><div><br/></div><div><span style="font-size: 11pt;">neutron.conf</span></div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">[DEFAULT]</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">state_path = /var/lib/neutron</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">auth_strategy = keystone</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">core_plugin = ml2</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">service_plugins = router</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">dhcp_agent_notification = true</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">allow_overlapping_ips = True</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">notify_nova_on_port_status_changes = true</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">notify_nova_on_port_data_changes = true</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">transport_url =</span> <a href="rabbit://openstack:admin@controller/" style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">rabbit://openstack:admin@controller</a></div><div><br style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);"/></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">[agent]</span></div><div><br style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);"/></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">[cors]</span></div><div><br style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);"/></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">[cors.subdomain]</span></div><div><br style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);"/></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">[database]</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">connection = mysql+</span><a href="pymysql://neutron:NEUTRON_DBPASS@controller/neutron" style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">pymysql://neutron:NEUTRON_DBPASS@controller/neutron</a></div><div><br style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);"/></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">[keystone_authtoken]</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">auth_uri =</span> <a href="http://controller:5000/" style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">http://controller:5000</a></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">auth_url =</span> <a href="http://controller:35357/" style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">http://controller:35357</a></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">memcached_servers = controller:11211</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">auth_type = password</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">project_domain_name = default</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">user_domain_name = default</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">project_name = service</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">username = neutron</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">password = neutron</span></div><div><br style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);"/></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">[matchmaker_redis]</span></div><div><br style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);"/></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">[nova]</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">region_name = RegionOne</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">auth_url =</span> <a href="http://controller:35357/" style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">http://controller:35357</a></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">auth_type = password</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">project_domain_name = default</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">project_name = service</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">user_domain_name = default</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">username = nova</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">password = nova</span></div><div><br style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);"/></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">[oslo_concurrency]</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">lock_path = $state_path/lock</span></div><div><br style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);"/></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">[oslo_messaging_amqp]</span></div><div><br style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);"/></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">[oslo_messaging_kafka]</span></div><div><br style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);"/></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">[oslo_messaging_notifications]</span></div><div><br style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);"/></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">[oslo_messaging_rabbit]</span></div><div><br style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);"/></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">[oslo_messaging_zmq]</span></div><div><br style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);"/></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">[oslo_middleware]</span></div><div><br style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);"/></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">[oslo_policy]</span></div><div><br style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);"/></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">[qos]</span></div><div><br style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);"/></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">[quotas]</span></div><div><br style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);"/></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">[ssl]</span></div><div><br style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);"/></div></div><div><br/></div><div>ml2_conf.ini</div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">[DEFAULT]</span></div><div><br style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);"/></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">[ml2]</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">type_drivers = flat,vxlan</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">tenant_network_types = vxlan</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">mechanism_drivers = openvswitch,l2population</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">extension_drivers = port_security</span></div><div><br style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);"/></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">[ml2_type_flat]</span></div><div><br style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);"/></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">[ml2_type_geneve]</span></div><div><br style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);"/></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">[ml2_type_gre]</span></div><div><br style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);"/></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">[ml2_type_vlan]</span></div><div><br style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);"/></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">[ml2_type_vxlan]</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">vni_ranges = 1:1000</span></div><div><br style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);"/></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">[securitygroup]</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">enable_ipset = true</span></div></div><div><br/></div><div>openvswitch_agent.ini</div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">[DEFAULT]</span></div><div><br style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);"/></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">[agent]</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">tunnel_types = vxlan</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">l2_population = True</span></div><div><br style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);"/></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">[ovs]</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">tunnel_bridge = br-tun</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">local_ip = 192.168.254.63</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">bridge_mappings =</span></div><div><br style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);"/></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">[securitygroup]</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">firewall_driver = iptables_hybrid</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">enable_security_group = true</span></div><div><br style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);"/></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">[xenapi]</span></div><div><br style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);"/></div></div><div><br/></div><div>l3_agent.ini</div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">[DEFAULT]</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">interface_driver = openvswitch</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">external_network_bridge = br-ex</span></div><div><br style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);"/></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">[agent]</span></div><div><br style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);"/></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">[ovs]</span></div></div><div><br/></div><div>metadata_agent.ini</div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">[DEFAULT]</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">nova_metadata_ip = controller</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">metadata_proxy_shared_secret = METADATA_SECRET</span></div><div><br style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);"/></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">[agent]</span></div><div><br style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);"/></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">[cache]</span></div></div><div><br/></div><div>dhcp_agent.ini</div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">[DEFAULT]</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">interface_driver = openvswitch</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">dhcp_driver = neutron.agent.linux.dhcp.Dnsmasq</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">enable_isolated_metadata = true</span></div><div><br style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);"/></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">[agent]</span></div><div><br style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);"/></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">[ovs]</span></div></div><div><br/></div><div><span style="-en-paragraph:true;"><span style="font-size: 11pt; color: rgb(255, 0, 0);">注意：配置完配置文件后，提前准备ovs外网用的网桥，之后同步数据库，启动服务：</span></span></div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">（控制）yum install openstack-neutron openstack-neutron-ml2 openvswitch openstack-neutron-openvswitch ebtables -y</span></div><div><br/></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">systemctl enable neutron-server.service</span> <span style="font-family: Monaco; font-size: 9pt;">neutron-dhcp-agent.service openvswitch neutron-openvswitch-agent <span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">neutron-metadata-agent.service</span></span></div><div><br/></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">systemctl start neutron-server.service</span> <span style="font-family: Monaco; font-size: 9pt;">neutron-dhcp-agent.service openvswitch neutron-openvswitch-agent<span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);"> </span><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">neutron-metadata-agent.service</span></span></div><div><br/></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">ovs-vsctl add-br br-ex</span></div><div><br/></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">ovs-vsctl add-port br-ex eth2</span></div><div><br/></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">systemctl enable neutron-l3-agent.service</span></div><div><br/></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">systemctl start neutron-l3-agent.service</span></div><div><br/></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">（计算）yum install </span><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">openvswitch openstack-neutron-openvswitch</span> <span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">ebtables ipset</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">systemctl enable</span> <span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">openvswitch neutron-openvswitch-agent</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">systemctl start</span> <span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">openvswitch neutron-openvswitch-agent</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">systemctl stop</span> <span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">openvswitch neutron-openvswitch-agent</span></div></div><div><br/></div></div><div><br/></div></span>
</div></body></html> 