<html>
<head>
  <title>Evernote Export</title>
  <basefont face="微软雅黑" size="2" />
  <meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
  <meta name="exporter-version" content="YXBJ Windows/600240 (zh-CN, DDL); Windows/10.0.0 (Win64);"/>
  <style>
    body, td {
      font-family: 微软雅黑;
      font-size: 10pt;
    }
  </style>
</head>
<body>
<a name="1381"/>

<div>
<span><div><b>一、环境准备</b></div><div>1、各主机配置静态域名解析：</div><div>cat /etc/hosts</div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">127.0.0.1   localhost localhost.localdomain localhost4 localhost4.localdomain4</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">::1         localhost localhost.localdomain localhost6 localhost6.localdomain6</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">192.168.210.131 node1 node1.test.com</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">192.168.210.130 node2 node2.test.com</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">192.168.210.132 node3 node3.test.com</span></div></div><div><br/></div><div>2、并配置各节点ssh无密钥登陆</div><div><br/></div><div>3、安装docker环境</div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">wget http://download2.yunwei.edu/shell/docker.tar.gz</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">tar zxf  docker.tar.gz</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">cd docker</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">sh docker</span></div></div><div><br/></div><div>4、下载配置文件并且导入镜像</div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">wget http://download2.yunwei.edu/shell/galera.tar.gz</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">tar zxf  galera.tar.gz</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">docker load -i mariadb-galera.tar</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">mkdir mkdir /opt/mariadb</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">#######将config.tar.gz 解压后，mv到mkdir /opt/mariadb，</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">tar zxf config.tar.gz &amp;&amp; mv config /opt/mariadb/</span></div></div><div><br/></div><div><b>二、配置集群</b></div><div>#######node1</div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">docker run -d --net host --name galera1 \</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">-e WSREP_NODE_ADDRESS=192.168.210.131 \</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">-e WSREP_CLUSTER_ADDRESS=</span><a href="gcomm://192.168.210.131:4567,192.168.210.130:4567,192.168.210.132:4567/" style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">gcomm://192.168.210.131:4567,192.168.210.130:4567,192.168.210.132:4567</a> <span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">\</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">-p 3306:3306 \</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">-p 4567:4567/udp \</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">-p 4567-4568:4567-4568 \</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">-p 4444:4444 \</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">-v /opt/mariadb/config/mysql:/etc/mysql \</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">-v /opt/mariadb/config/data:/var/lib/mysql:Z \</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">--restart=always \</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">panubo/mariadb-galera mysqld</span></div></div><div><br/></div><div>#######node2</div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">docker run -d --net host --name galera2 \</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">-e WSREP_NODE_ADDRESS=192.168.210.130 \</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">-e WSREP_CLUSTER_ADDRESS=</span><a href="gcomm://192.168.210.131:4567,192.168.210.130:4567,192.168.210.132:4567/" style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">gcomm://192.168.210.131:4567,192.168.210.130:4567,192.168.210.132:4567</a> <span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">\</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">-p 3306:3306 \</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">-p 4567:4567/udp \</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">-p 4567-4568:4567-4568 \</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">-p 4444:4444 \</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">-v /opt/mariadb/config/mysql:/etc/mysql \</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">-v /opt/mariadb/config/data:/var/lib/mysql:Z \</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">--restart=always \</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">panubo/mariadb-galera mysqld</span></div></div><div><br/></div><div>#########node3</div><div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">docker run -d --net host --name galera3 \</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">-e WSREP_NODE_ADDRESS=192.168.210.132 \</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">-e WSREP_CLUSTER_ADDRESS=</span><a href="gcomm://192.168.210.131:4567,192.168.210.130:4567,192.168.210.132:4567/" style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">gcomm://192.168.210.131:4567,192.168.210.130:4567,192.168.210.132:4567</a> <span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">\</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">-e MYSQL_ROOT_PASSWORD=123 \</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">-p 3306:3306 \</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">-p 4567:4567/udp \</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">-p 4567-4568:4567-4568 \</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">-p 4444:4444 \</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">-v /opt/mariadb/config/mysql:/etc/mysql \</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">-v /opt/mariadb/config/data:/var/lib/mysql:Z \</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">--restart=always \</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">panubo/mariadb-galera mysqld --wsrep-new-cluster</span></div></div><br/></div><div><br/></div><div><br/></div><div><b>三、登陆数据库时，安装mariadb客户端</b></div><div>yum install mariadb -y</div><div>mysql -h <span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">192.168.210.131</span> -P 3306 -u root -p123</div><div><br/></div><div>检查集群状态：</div><div>SHOW STATUS LIKE 'wsrep_cluster_size';</div><div>+--------------------+-------+</div><div>| Variable_name      | Value |</div><div>+--------------------+-------+</div><div>| wsrep_cluster_size | 3     |</div><div>+--------------------+-------+</div><div><br/></div><div><br/></div><div><b>四、故障恢复：</b></div><div>（1）集群中某slave节点down机，重启该节点后，重启docke容器即可；</div><div>（2）集群中master节点down机，重启该master节点后，master-docker容器不能正常启动，因为这是master节点已经切换，</div><div>         需要将原先master-docker容器删除，再以非wrsep方式启动一个普通容器；</div><div>（3）集群全部意外down机，强制找一台节点作为master节点；到如下路径，将 safe_to_bootstrap: 0修改为1（平时集群正常时，每个节点都为0）</div><div>[root@con3 data]# pwd</div><div>/opt/mariadb/data</div><div>[root@con3 data]# cat grastate.dat</div><div># GALERA saved state</div><div>version: 2.1</div><div>uuid:    6a26abec-e7b5-11e8-b15b-b74046986de4</div><div>seqno:   -1</div><div>safe_to_bootstrap: 0</div><div><br/></div><div>之后在该节点启动wsrep进程的docker</div></span>
</div></body></html> 